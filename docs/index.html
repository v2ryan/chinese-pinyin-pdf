<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chinese — 拼音(聲調) + PDF</title>
  <style>
    :root{ --bg:#0b1220; --panel:#101a33; --card:#111b33; --text:#eaf0ff; --muted:#aab6d6; --border: rgba(255,255,255,.12); --btn:#2b62ff; --btn2:#253055; --danger:#ff5b5b; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background: radial-gradient(1200px 800px at 20% 10%, #16224a, var(--bg)); color:var(--text); }
    header{ border-bottom:1px solid var(--border); background: rgba(11,18,32,.75); backdrop-filter: blur(10px); position: sticky; top:0; z-index:10; }
    .wrap{ width:min(1100px, 94vw); margin:0 auto; padding: 12px 0; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .brand{ display:flex; flex-direction:column; }
    .brand b{ font-size: 14px; letter-spacing:.2px; }
    .brand span{ font-size: 12px; color:var(--muted); }
    nav a{ color: var(--muted); text-decoration:none; margin-left: 12px; font-size: 13px; }
    nav a.active{ color: var(--text); font-weight: 700; }

    main{ width:min(1100px, 94vw); margin:0 auto; padding: 16px 0 60px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{ background: rgba(17,27,51,.70); border:1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: 0 10px 35px rgba(0,0,0,.35); }
    h1{ margin:0 0 8px 0; font-size: 18px; }
    p{ margin: 0 0 10px 0; color: var(--muted); font-size: 13px; }

    textarea{ width:100%; min-height: 260px; resize: vertical; padding: 10px 12px; border-radius: 12px; border:1px solid var(--border); background: rgba(255,255,255,.06); color: var(--text); outline:none; line-height: 1.5; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }
    button{ border:0; border-radius: 12px; padding: 10px 12px; font-weight: 750; cursor:pointer; color:white; }
    .primary{ background: var(--btn); }
    .ghost{ background: var(--btn2); }
    .danger{ background: var(--danger); }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .para{ display:grid; grid-template-columns: 40px 1fr; gap:10px; align-items:flex-start; padding: 10px; border-radius: 14px; border: 1px solid var(--border); background: rgba(255,255,255,.04); }
    .para label{ font-size: 12px; color: var(--muted); display:flex; align-items:center; gap:6px; }
    .preview{ overflow:auto; max-height: 520px; }

    /* Pinyin above hanzi (stacked cells, PDF-friendly) */
    .doc{ text-align: left; color:#000; background:#fff; padding: 24px; border-radius: 10px; }
    .doc .p{ margin: 0 0 14px 0; line-height: 1.6; font-size: 18px; }
    .line{ display:flex; flex-wrap:wrap; align-items:flex-end; gap: 2px 2px; }
    .cell{ display:inline-flex; flex-direction:column; align-items:center; justify-content:flex-end; }
    .py{ font-size: 11px; line-height: 1; color:#333; min-height: 12px; }
    .hz{ font-size: 18px; line-height: 1.2; }

    .hint{ font-size: 12px; color: var(--muted); margin-top: 10px; }
    .small{ font-size: 12px; color: var(--muted); }
    code{ background: rgba(0,0,0,.25); padding: 1px 6px; border-radius: 8px; }

    /* print */
    @media print {
      body{ background:#fff; }
      header, .no-print{ display:none !important; }
      main{ width: auto; }
    }
  </style>

  <!-- pinyin-pro (tone marks) -->
  <script src="https://cdn.jsdelivr.net/npm/pinyin-pro/dist/index.min.js"></script>
  <!-- html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <header class="no-print">
    <div class="wrap">
      <div class="brand">
        <b>Chinese</b>
        <span>每字拼音 + 聲調（1A+2A）｜一鍵匯出 PDF</span>
      </div>
      <nav>
        <a href="#" class="active">Chinese</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card no-print">
        <h1>輸入中文</h1>
        <p>貼入文字（用空行分段）。右邊會即時生成「每字拼音（聲調）」預覽。每段旁邊可以選擇要唔要輸出。</p>
        <textarea id="input" placeholder="例如：
今天我很開心。

我們一起學中文。"></textarea>
        <div class="row">
          <button class="primary" id="btnRender">生成預覽</button>
          <button class="ghost" id="btnSelectAll">全選段落</button>
          <button class="ghost" id="btnSelectNone">全不選</button>
          <button class="primary" id="btnPdf">匯出 PDF</button>
          <button class="danger" id="btnClear">清空</button>
        </div>
        <div class="hint">PDF 會保持<strong>左對齊</strong>，同保留你分段。拼音用 <code>pinyin-pro</code> 自動生成（普通話，帶聲調符號）。</div>
      </section>

      <section class="card">
        <h1 class="no-print">預覽（左邊選段落 → 匯出 PDF）</h1>
        <div id="paraList" class="list no-print"></div>
        <div class="preview">
          <div id="doc" class="doc"></div>
        </div>
        <div class="small no-print">提示：如果某些字係專有名詞/多音字，拼音可能要你手動改（下一版可以加「手動修正」功能）。</div>
      </section>
    </div>
  </main>

  <script>
    const { pinyin } = window.pinyinPro || {};

    const inputEl = document.getElementById('input');
    const paraListEl = document.getElementById('paraList');
    const docEl = document.getElementById('doc');

    function splitParagraphs(text){
      // split by blank lines
      return text
        .replace(/\r\n/g, '\n')
        .split(/\n\s*\n+/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function isCJK(ch){
      // CJK Unified Ideographs + Ext A + Compatibility Ideographs
      return /[\u3400-\u9FFF\uF900-\uFAFF]/.test(ch);
    }

    function cellForChar(ch){
      if (ch === '
') return '<br/>';
      if (!isCJK(ch)) {
        // Keep punctuation/latin; still reserve pinyin height for alignment
        const safe = escapeHtml(ch);
        return `<span class="cell"><span class="py">&nbsp;</span><span class="hz">${safe}</span></span>`;
      }
      if (typeof pinyin !== 'function') {
        const safe = escapeHtml(ch);
        return `<span class="cell"><span class="py">&nbsp;</span><span class="hz">${safe}</span></span>`;
      }
      const py = (pinyin(ch, { toneType: 'symbol', type: 'array' }) || [''])[0] || '';
      const safeCh = escapeHtml(ch);
      const safePy = py ? escapeHtml(py) : '&nbsp;';
      return `<span class="cell"><span class="py">${safePy}</span><span class="hz">${safeCh}</span></span>`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    function renderDoc(paras, selected){
      const html = paras.map((para, idx) => {
        if (!selected[idx]) return '';
        const chars = [...para];
        const line = chars.map(rubyForChar).join('');
        return `<p class="p">${line}</p>`;
      }).join('');
      docEl.innerHTML = html || '<p class="p">（未選擇任何段落）</p>';
    }

    function render(){
      const paras = splitParagraphs(inputEl.value);
      const selected = paras.map(() => true);

      // Build checkbox list
      paraListEl.innerHTML = '';
      paras.forEach((para, idx) => {
        const row = document.createElement('div');
        row.className = 'para';
        row.innerHTML = `
          <label>
            <input type="checkbox" data-idx="${idx}" checked />
            輸出
          </label>
          <div class="small">${escapeHtml(para).slice(0, 140)}${para.length>140?'…':''}</div>
        `;
        paraListEl.appendChild(row);
      });

      const update = () => {
        const sel = paras.map((_, i) => {
          const cb = paraListEl.querySelector(`input[data-idx="${i}"]`);
          return cb ? cb.checked : true;
        });
        renderDoc(paras, sel);
      };

      paraListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', update);
      });

      // select all/none
      document.getElementById('btnSelectAll').onclick = () => {
        paraListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        update();
      };
      document.getElementById('btnSelectNone').onclick = () => {
        paraListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        update();
      };

      update();
    }

    async function exportPdf(){
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS) {
        // iOS Safari renders complex layouts to canvas unreliably; use Print -> Save as PDF
        const w = window.open('', '_blank');
        const html = `<!doctype html><html><head><meta charset="utf-8"><title>chinese-pinyin</title>
          <style>body{margin:0;font-family:-apple-system,system-ui;} .doc{padding:24px;} .p{margin:0 0 14px 0;} .line{display:flex;flex-wrap:wrap;align-items:flex-end;gap:2px 2px;} .cell{display:inline-flex;flex-direction:column;align-items:center;justify-content:flex-end;} .py{font-size:11px;line-height:1;color:#333;min-height:12px;} .hz{font-size:18px;line-height:1.2;} @page{margin:12mm;} </style>
        </head><body>${docEl.outerHTML}<script>window.onload=()=>setTimeout(()=>window.print(),200);<\/script></body></html>`;
        w.document.open();
        w.document.write(html);
        w.document.close();
        return;
      }

      const opt = {
        margin: [10, 10, 10, 10],
        filename: 'chinese-pinyin.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] },
      };
      await html2pdf().set(opt).from(docEl).save();
    }

    document.getElementById('btnRender').addEventListener('click', render);
    document.getElementById('btnPdf').addEventListener('click', exportPdf);
    document.getElementById('btnClear').addEventListener('click', () => {
      inputEl.value = '';
      render();
    });

    // default sample
    inputEl.value = "今天我很開心。\n\n我們一起學中文。\n\n只要每天練習十分鐘，就會有進步。";
    // render after libs loaded
    window.addEventListener('load', () => render());
  </script>
</body>
</html>
